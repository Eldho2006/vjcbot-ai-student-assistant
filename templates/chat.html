{% extends "base.html" %}

{% block title %}Chat - VJCBOT{% endblock %}

{% block content %}
<div class="row justify-content-center h-100">
    <div class="col-md-8">
        <div class="card shadow" style="height: 75vh;">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>Chat with VJCBOT</span>
                <!-- Optional: User specific upload -->
                <button class="btn btn-sm btn-light" data-bs-toggle="modal" data-bs-target="#uploadModal">
                    Upload Context
                </button>
            </div>
            <div class="card-body d-flex flex-column">
                <div id="chat-box" class="flex-grow-1 overflow-auto mb-3 p-3 border rounded bg-white">
                    <div class="text-center text-muted small mt-2">Start conversation or upload a document to ask about
                        it.</div>
                </div>

                <div class="input-group">
                    <input type="text" id="user-input" class="form-control" placeholder="Type your question..."
                        onkeypress="handleEnter(event)">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Personal Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('main.upload_file') }}" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <input type="file" class="form-control" name="file" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    async function sendMessage() {
        const input = document.getElementById('user-input');
        const message = input.value.trim();
        if (!message) return;

        appendMessage('You', message, 'text-end');
        input.value = '';
        input.disabled = true;

        // Show loading
        const loadingId = appendMessage('Bot', 'Thinking...', 'text-start');

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message })
            });
            const data = await response.json();

            // Remove loading and show answer
            document.getElementById(loadingId).remove();
            appendMessage('Bot', data.response, 'text-start');
        } catch (error) {
            console.error('Error:', error);
            document.getElementById(loadingId).innerText = 'Error: could not reach server.';
        }
        input.disabled = false;
        input.focus();
    }

    function appendMessage(sender, text, alignClass) {
        const box = document.getElementById('chat-box');
        const msgDiv = document.createElement('div');
        msgDiv.className = `mb-2 ${alignClass}`;
        const id = 'msg-' + Date.now();
        msgDiv.id = id;

        let bubbleColor = sender === 'You' ? 'bg-primary text-white' : 'bg-light text-dark border';

        msgDiv.innerHTML = `
            <div class="d-inline-block p-2 rounded ${bubbleColor}" style="max-width: 80%;">
                <strong>${sender}:</strong> ${text.replace(/\n/g, '<br>')}
            </div>
        `;
        box.appendChild(msgDiv);
        box.scrollTop = box.scrollHeight;
        return id;
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }
</script>
{% endblock %}